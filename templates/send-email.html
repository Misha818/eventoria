{% extends "base.html" %}

{% block title %}
    {{ _('Send Email') }}
{% endblock %}

{% block head %}

<link rel="stylesheet" href="{{ url_for('static', filename='quill.snow.css') }}">

<!-- Pickr themes (Color picker for reach text editor) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/monolith.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css"/>

<link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto|Lato|Oswald|Playfair+Display|Raleway" rel="stylesheet">

<style>
.ql-snow .ql-picker.ql-font .ql-picker-label::before, .ql-snow .ql-picker.ql-font .ql-picker-item::before {
    content: 'Montserrat';
}

.ql-snow .ql-picker.ql-font {
    width: 120px;
}

#response {
    width: 90%;
    margin: 50px auto 15px auto;
}


/* When collapsed, this shows the current font name above the picker */
.ql-snow .ql-picker.ql-font .ql-picker-label::before {
  content: attr(data-value);
  /* font-family: attr(data-value);; */
  text-transform: capitalize;
  /* font-variant: small-caps; */
  letter-spacing: 0.03em;
  color: #4a4a4a;
}

.ql-snow .ql-picker.ql-font 
  .ql-picker-item[data-value="playfair-display"]::before,
.ql-snow .ql-picker.ql-font 
  .ql-picker-label[data-value="playfair-display"]::before {
  content: "Playfair Display";     /* no hyphen */
  font-family: "Playfair Display", serif;
  width:120px;
  /* you can still apply text-transform or letter-spacing here if you like */
}

.ql-snow .ql-picker.ql-font .ql-picker-label[data-value="montserrat"]::before {
  content: 'Montserrat';
  font-family: 'Montserrat', sans-serif;
}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value="lato"]::before {
  content: 'Lato';
  font-family: 'Lato', sans-serif;
}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value="roboto"]::before {
  content: 'Roboto';
  font-family: 'Roboto', sans-serif;
}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value="playfair-display"]::before {
  content: 'Playfair Display';
  font-family: 'Playfair Display', serif;
}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value="raleway"]::before {
  content: 'Raleway';
  font-family: 'Raleway', sans-serif;
}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value="cursive"]::before {
  content: 'Cursive';
  font-family: cursive;
}




/* Each item in the open menu: */
.ql-snow .ql-picker.ql-font .ql-picker-item[data-value="montserrat"]::before {
  content: 'Montserrat';
  font-family: 'Montserrat', sans-serif;
}
.ql-snow .ql-picker.ql-font .ql-picker-item[data-value="lato"]::before {
  content: 'Lato';
  font-family: 'Lato', sans-serif;
}
.ql-snow .ql-picker.ql-font .ql-picker-item[data-value="roboto"]::before {
  content: 'Roboto';
  font-family: 'Roboto', sans-serif;
}

.ql-snow .ql-picker.ql-font .ql-picker-item[data-value="raleway"]::before {
  content: 'Raleway';
  font-family: 'Raleway', sans-serif;
}
.ql-snow .ql-picker.ql-font .ql-picker-item[data-value="cursive"]::before {
  content: 'Cursive';
  font-family: cursive;
}


.scroll-container {
        overflow: auto;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none;  /* IE 10+ */
      }
      
      .scroll-container::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      /* kill Quill’s defaults */
.ql-snow .ql-picker.ql-size .ql-picker-item::before,
.ql-snow .ql-picker.ql-size .ql-picker-label::before {
  content: none !important;
}


/* Dropdown items */
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="8px"]::before { content: "8"  !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="9px"]::before { content: "9"  !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="10px"]::before { content: "10" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="11px"]::before { content: "11" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="12px"]::before { content: "12" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="14px"]::before { content: "14" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="16px"]::before { content: "16" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="18px"]::before { content: "18" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="20px"]::before { content: "20" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="24px"]::before { content: "24" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="28px"]::before { content: "28" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="32px"]::before { content: "32" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="36px"]::before { content: "36" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="48px"]::before { content: "48" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="72px"]::before { content: "72" !important; } 

/* 3) Toolbar label (current selection) */
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="8px"]::before { content: "8"  !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="9px"]::before { content: "9"  !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="10px"]::before { content: "10" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="11px"]::before { content: "11" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="12px"]::before { content: "12" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="14px"]::before { content: "14" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="16px"]::before { content: "16" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="18px"]::before { content: "18" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="20px"]::before { content: "20" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="24px"]::before { content: "24" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="28px"]::before { content: "28" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="32px"]::before { content: "32" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="36px"]::before { content: "36" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="48px"]::before { content: "48" !important; }
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="72px"]::before { content: "72" !important; } 

.pickr {
    display: none!important;
}

</style>

{% endblock %}

{% block content %}

{{ sideBar | safe }}



<div class="container toRight" id="tableDaddy" style="width: 987px;">
    {% set email = '' %}
    {% set emailID = '' %}

    {% if filterContent | length > 0 %}
        {% if filterContent.email %}
            {% set email = filterContent.email %}
        {% endif %}

        {% if filterContent.emailID and filterContent.emailID is digit %}
            {% set emailID = filterContent.emailID | int %}
        {% endif %}
    {% endif %}
<div id="response"></div>
<div class="mb-3 transfer-funds">

    {% if result.length > 0 %}
        <select id="from" class="styled-select" style="margin-bottom: 10px;">
            <option value="">{{ _('Choose sender email address') }}</option>
            {% for val in result.data %}                
                {% set selected = '' %}
                {% if result.length == 1 %}
                    {% set selected = 'selected' %}
                {% elif emailID != '' %}
                    {% if emailID == val['ID'] %}
                        {% set selected = 'selected' %}
                    {% endif %}                
                {% endif %}
                <option value="{{ val['ID'] }}" {{ selected }}>
                    {{ val['email'] }}
                </option>
            {% endfor %}
        </select>
        
    {% endif %}

    <input type="email" id="to" value="{{ email }}" placeholder="{{ _('Enter recipient email address') }}"  style="width: 100%; height: 45px;">
    <input type="text" id="subject" placeholder="{{ _('Subject') }}"  style="width: 100%; height: 45px;">

    <!-- Quill.js editor container -->
    <!-- <div id="editor" ></div> -->

        <div id="text-pickr-container" style="display: none;"></div>
        <div id="bg-pickr-container"   style="display: none;"></div>
        <div id="editor-wrapper" class="quill-editor scroll-container" style="overflow-y: auto;">
            <div id="editor-container" style="width: 100%; min-height: 300px; margin-top: unset; margin-bottom: unset;"></div>
        </div>

            <div class="containerH toRight tableDaddy">
                <div class="pcButtonS" id="submit">{{ _('Submit')}}</div>
                <div class="pcButtonS hidden" id="saving">{{ _('Saving...')}}</div>
            </div>

        <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
</div>



</div>

<script src="{{ url_for('static', filename='JS/1-3-6-quill.js') }}"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    

    function imageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = function () {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const base64String = e.target.result;
                        const base64WithFileName = 'data:' + file.type + ';filename=' + file.name + ';base64,' + base64String.split(',')[1];
                        insertBase64Image(base64WithFileName);
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function insertBase64Image(base64String) {
            const range = quill.getSelection();
            quill.insertEmbed(range.index, 'image', base64String);
        }

//     const Font = Quill.import('formats/font');
//     const fonts = [
//         'montserrat',
//         'lato',
//         'roboto',
//         // 'oswald',
//         'playfair-display',
//         'raleway',
//         'cursive'
//     ];

//     Font.whitelist = fonts;
//     Quill.register(Font, true);

       
//     // Initialize Quill.js editor
//     const toolbarOptions = [
//         ['bold', 'italic', 'underline', 'strike'],
//         // ['blockquote', 'code-block'],
//         // ['link', 'image', 'video', 'formula'],
//         ['link'],
//         // [{ 'header': 1 }, { 'header': 2 }],
//         [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'list': 'check' }],
//         // [{ 'script': 'sub' }, { 'script': 'super' }],
//         [{ 'indent': '-1' }, { 'indent': '+1' }],
//         [{ 'direction': 'rtl' }],
//         [{ 'size': ['small', false, 'large', 'huge'] }],
//         [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
//         [{ 'color': [] }, { 'background': [] }],
//         // [{ 'font': ['roboto', 'montserrat', 'lato', 'oswald', 'playfair', 'raleway'] }],
//         [{ 'font': fonts }],
//         [{ 'align': [] }]
//     ];



// const quill = new Quill('#editor', {
//   theme: 'snow',
//   placeholder: "{{ _('Additional notes') }}",
//   modules: {
//     toolbar: {
//       container: toolbarOptions, 
//       handlers: {
//         image: imageHandler
//       }
//     }
//   }
// });



// // Select the target element
// const fontLabel = document.querySelector('.ql-font .ql-picker-label');

// if (fontLabel) {
//   // Create a MutationObserver instance to watch for attribute changes
//   const observer = new MutationObserver((mutationsList) => {
//     mutationsList.forEach((mutation) => {
//       if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
//         const newValue = fontLabel.getAttribute('data-value');
//         // console.log('New data-value:', newValue);
//         updateCSSContent(newValue);
//       }
//     });
//   });

//   // Start observing the target element for attribute changes to 'data-value'
//   observer.observe(fontLabel, { attributes: true, attributeFilter: ['data-value'] });
// } else {
//   console.warn('Element .ql-font .ql-picker-label not found');
// }


// // Function to update (or create) a style element with new CSS rule
// function updateCSSContent(newValue) {
//   newValue = formatFontName(newValue); 
//   // Try to find an existing style element we can update
//   let styleElem = document.getElementById('dynamic-font-style');
//   if (!styleElem) {
//     styleElem = document.createElement('style');
//     styleElem.id = 'dynamic-font-style';
//     document.head.appendChild(styleElem);
//   }
//   // Update the CSS rule. The content property must be quoted.
//   styleElem.innerHTML = `
//     .ql-snow .ql-picker.ql-font .ql-picker-label::before,
//     .ql-snow .ql-picker.ql-font .ql-picker-item::before {
//       content: '${newValue}';
//       font-family: '${newValue}';
//     }
//   `;
// }


// function formatFontName(fontKey) {
//   return fontKey
//     .split('-') // split by dash
//     .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // capitalize each part
//     .join(' '); // rejoin with space
// }



const Font = Quill.import('formats/font');
    const fonts = [
        'montserrat',
        'lato',
        'roboto',
        'raleway',
        'cursive'
    ];

    Font.whitelist = fonts;
    Quill.register(Font, true);

    
    let Size = Quill.import('attributors/style/size');
    // Define exactly the sizes you want (with units!)
    Size.whitelist = [
    '8px', '9px', '10px', '11px', '12px', '14px',
    '16px', '18px', '20px', '24px', '28px', '32px',
    '36px', '48px', '72px'
    ];

    // Tell Quill to use your version
    Quill.register(Size, true);

    // Initialize Quill.js editor
    const toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote'],
        ['link', 'image'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'list': 'check' }],
        [{ 'script': 'sub' }, { 'script': 'super' }],
        [{ 'indent': '-1' }, { 'indent': '+1' }],
        [{ 'direction': 'rtl' }],
        // [{ 'size': ['small', false, 'large', 'huge'] }],
        [{ 'size': Size.whitelist }],
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'font': Font.whitelist }],
        [{ 'align': [] }],
        ['clean']
    ];

    function imageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = function () {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const base64String = e.target.result;
                        const base64WithFileName = 'data:' + file.type + ';filename=' + file.name + ';base64,' + base64String.split(',')[1];
                        insertBase64Image(base64WithFileName);
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function insertBase64Image(base64String) {
            const range = quill.getSelection();
            quill.insertEmbed(range.index, 'image', base64String);
        }

    const quill = new Quill('#editor-container', {
        modules: { 
            toolbar: {
                    container: toolbarOptions,
                    // container: '#toolbar',
                    handlers: {
                        'image': imageHandler
                    }
                }
            
        },
        theme: 'snow',
        scrollingContainer: '#editor-wrapper'
    });

    quill.format('font', 'montserrat');
    const tb = quill.getModule('toolbar').container;
    tb.id = 'toolbar';

    // 1. grab references to the toolbar’s <select> and its label
const toolbar = quill.getModule('toolbar').container;
const selectFont = toolbar.querySelector('select.ql-font');
const labelFont  = toolbar.querySelector('.ql-font .ql-picker-label');

// 2. a helper to pull the font and update the UI
function syncFontPicker(range) {
  // getFormat on a collapsed range tells you the active format
  const { font } = quill.getFormat(range) || {};
  const value = font || '';        // empty string = browser default

  if (selectFont) {
    selectFont.value = value;
    // Snow’s picker listens for 'change' on the <select>
    selectFont.dispatchEvent(new Event('change'));
  }
  if (labelFont) {
    // this updates the pseudo‐element via your existing CSS mapping
    labelFont.setAttribute('data-value', value);
  }
}

// 3. run it on every cursor movement
quill.on('selection-change', (range) => {
  if (range) syncFontPicker(range);
});

// 4. and finally, prime it once at startup
syncFontPicker(quill.getSelection());

const textColorPickr = Pickr.create({
  el:  '#text-pickr-container',
  theme: 'classic',
  default: '#FCC628',
  position: 'top-middle',
  autoReposition: false, 
  components: {
    preview: true, opacity: true, hue: true,
    interaction: { hex: true, input: true, clear: true, save: true }
  }
});
const bgColorPickr = Pickr.create({
  el:  '#bg-pickr-container',
  theme: 'classic',
  default: '#ccc',
  position: 'top-middle',   
  autoReposition: true, 
  components: {
    preview: true, opacity: true, hue: true,
    interaction: { hex: true, input: true, clear: true, save: true }
  }
});

// 3. when they click “save,” apply to Quill
textColorPickr.on('save', color => {
  const hex = color.toHEXA().toString();
  const range = quill.getSelection();
  if (range) quill.format('color', hex);
  textColorPickr.hide();
});
bgColorPickr.on('save', color => {
  const hex = color.toHEXA().toString();
  const range = quill.getSelection();
  if (range) quill.format('background', hex);
  bgColorPickr.hide();
});

// grab the Quill “A” icons
const textLabel = document.querySelector('.ql-color .ql-picker-label');
const bgLabel   = document.querySelector('.ql-background .ql-picker-label');

textLabel.addEventListener('click', e => {
  e.preventDefault();
  e.stopPropagation();
  textColorPickr.show();
});

bgLabel.addEventListener('click', e => {
  e.preventDefault();
  e.stopPropagation();
  bgColorPickr.show();
});

textColorPickr.on('save', color => {
  quill.format('color', color.toHEXA().toString());
  textColorPickr.hide();
});
bgColorPickr.on('save', color => {
  quill.format('background', color.toHEXA().toString());
  bgColorPickr.hide();
});


// after you’ve whitelisted & registered Font and init’d Quill…
const fontPicker = document.querySelector('.ql-picker.ql-font');





        let csrfToken = "{{ csrf_token() }}";
        document.getElementById('submit').onclick = function() {
            event.preventDefault(); // Prevent form submission
            clickedBotton = document.getElementById('submit');
            let loader = myLoader('#fff');    
            
            clickedBotton.textContent = '';
            clickedBotton.appendChild(loader);

            let gearElement = document.getElementById('gear');
            if (!gearElement) {
            return;
            } 
            rotate(gearElement);

            let response = document.querySelector("#response");
            response.innerHTML = "";
            response.style.display = 'none';
            document.getElementById("from").style.borderColor = "black";
            document.getElementById("to").style.borderColor = "black";
            document.getElementById("subject").style.borderColor = "black";

            let answer;

            let from = document.getElementById("from").value;
            if (!from) {
                response.innerHTML = "{{ _('Please specify sender email address!') }}";
                response.style.display = 'flex';
                document.getElementById("from").style.borderColor = "red";

                gearElement.remove();
                clickedBotton.textContent = `{{ _('Submit') }}`;
                return;
            }
            
            let to = document.getElementById("to").value;
            if (!to) {
                response.innerHTML = "{{ _('Please specify recipient email address!') }}";
                response.style.display = 'flex';
                document.getElementById("to").style.borderColor = "red";

                gearElement.remove();
                clickedBotton.textContent = `{{ _('Submit') }}`;
                return;
            }
            
            let subject = document.getElementById("subject").value;
            if (!subject) {
                response.innerHTML = "{{ _('Please specify subject!') }}";
                response.style.display = 'flex';
                document.getElementById("subject").style.borderColor = "red";

                gearElement.remove();
                clickedBotton.textContent = `{{ _('Submit') }}`;
                return;
            }

            
            let content = quill.root.innerHTML;
            const delta = quill.getContents();
            const hasContent = delta.ops.some(op => {
                return op.insert && typeof op.insert === 'string' && op.insert.trim() !== '';
            });
                
            let formData = new FormData();

            formData.append('from', from)     
            formData.append('to', to)     
            formData.append('subject', subject)     
            formData.append('content', content)     

            // Create a new XMLHttpRequest object
            let xhr = new XMLHttpRequest();
            
            // Configure the request
            xhr.open('POST', '/send-email');
            xhr.setRequestHeader('X-CSRFToken', csrfToken);

            // Define what happens on successful data submission
            xhr.onload = function () {
                if (xhr.status === 200) {
                    gearElement.remove();
                    clickedBotton.textContent = `{{ _('Submit') }}`;
                    const response = JSON.parse(xhr.responseText);
                    if (response.status === '1') {
                        alert(response.answer)
                        
                    }
                    
                    if (response.status === '0') {
                        document.querySelector("#response").textContent = response.answer;
                        document.querySelector("#response").style.display = 'flex';
                        return;
                    } 
                    
                    
                } else {
                    gearElement.remove();
                    clickedBotton.textContent = `{{ _('Submit') }}`;
                    console.error('Request failed with status: ' + xhr.status);
                }
            };

            // Define what happens in case of error
            xhr.onerror = function () {
                console.error('Request failed.');
            };

            // Send the request with the JSON data
            xhr.send(formData);
        };


    function rotate(gearElement) {
        let angle = 0;
        setInterval(() => {
            angle = (angle + 5) % 360; 
            gearElement.style.transform = `rotate(${angle}deg)`;
        }, 50); 
    
    }

    function myLoader(color) {
        if (color === undefined) {
          color = 'crimson'
        }
        let loader = document.createElement('div'); // Create a div element for the loader
          loader.id = 'gear';
          loader.style.color = color;
          loader.style.fontSize = '20px';
          loader.style.display = 'inline-block';
          loader.textContent = '⚙';
          return loader;
    }
});

    </script>

{% endblock %}
